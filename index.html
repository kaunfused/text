<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text Sentiment Predictor</title>
    <link href="./output.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/creativetimofficial/tailwind-starter-kit/compiled-tailwind.min.css"
    />

    <style>
      #predict {
        transition: all 0.3s ease-in-out;
        margin: 3rem;
      }

      #predict:hover {
        border-radius: 1rem;
        border-radius: 2px solid #484f5a;
      }
    </style>
  </head>

  <body>
    <h1
      class="text-5xl font-sans font-bold text-gray-400 text-center decoration-yellow-500 m-8 tracking-wide"
    >
      Text
      <span class="text-blue-500 italic"> Sentiment </span>
      Prediction
    </h1>

    <p class="m-10 text-center text-2xl font-sans">
      Text sentiment prediction is a powerful tool that can help you to
      understand the emotions and opinions expressed in your text data. This
      information can be used to improve your business in a number of ways.
    </p>

    <p class="m-10 text-center text-2xl font-sans text-blue-500 italic">
      NOTE: Either upload a file or enter text to get your predictions!
    </p>

    <form
      id="predictionForm"
      class="flex flex-col justify-center items-center w-3/4 mx-auto my-20 min-h-40"
    >
      <input type="file" id="csvFileInput" accept=".csv" />
      <div class="box" style="display: flex; flex-direction: column">
        <textarea
          id="textInput"
          class="border-slate-300 rounded-lg"
          placeholder="Enter text..."
          style="
            min-height: 5rem;
            overflow: hidden;
            min-width: 20rem;
            resize: none;
            padding: 0.5rem;
            margin: 1rem;
          "
        ></textarea>

        <button
          type="button"
          id="predict"
          onclick="predict()"
          style="margin-top: 0.4rem; border: 2px solid #94a3b8"
        >
          Predict
        </button>
      </div>

      <button
        id="downloadBtn"
        style="display: none"
        onclick="downloadPredictions()"
      >
        Download Predictions
      </button>
    </form>

    <div class="w-full md:w-4/12 ml-auto mr-auto px-4">
      <div>
        <h1 class="text-4xl">Prediction Result</h1>
        <div class="p-4 m-2 border">
          <div id="predictionResult"></div>
        </div>
      </div>
      <div class="pt-6">
        <h1 class="text-4xl">graph Result</h1>
        <div class="p-4 m-2 border">
          <div id="graphContainer"></div>
        </div>
      </div>
      <button
        id="downloadBtn"
        style="display: none"
        onclick="downloadPredictions()"
        class="text-lg font-semibold bg-gray-800 w-full text-white rounded-lg px-6 py-3 mt-10 block shadow-xl hover:text-white hover:bg-black"
      >
        Download Predictions
      </button>
    </div>

    <script>
      function predict() {
        // Check if CSV file is present
        var csvFileInput = document.getElementById("csvFileInput");
        var textInput = document.getElementById("textInput");
        var predictionResult = document.getElementById("predictionResult");
        var graphContainer = document.getElementById("graphContainer");

        if (csvFileInput.files.length > 0) {
          // Upload CSV file
          var formData = new FormData();
          formData.append("file", csvFileInput.files[0]);

          fetch("http://localhost:5000/predict", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (response.headers.get("X-Graph-Exists") === "true") {
                console.log("Graph");
                var graphData = response.headers.get("X-Graph-Data");
                displayGraph(graphData);
              }

              return response.blob();
            })
            .then((blob) => {
              console.log("Blob:", blob);

              document.getElementById("downloadBtn").style.display = "block";
              document.getElementById("downloadBtn").onclick = function () {
                console.log("Downloading...");
                var url = URL.createObjectURL(blob);
                console.log("URL:", url);

                var a = document.createElement("a");
                a.href = url;
                a.download = "Predictions.csv";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
              };
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        } else if (textInput.value.trim() !== "") {
          // Predict on single sentence
          fetch("http://localhost:5000/predict", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ text: textInput.value.trim() }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log(data);
              predictionResult.innerHTML =
                "Predicted sentiment: " + data.prediction;
            });
        }
      }

      function downloadPredictions() {
        console.log("Download prediction");
      }

      function displayGraph(graphData) {
        var graphUrl = "data:image/png;base64," + graphData;
        var img = document.createElement("img");
        img.src = graphUrl;
        graphContainer.appendChild(img);
      }
    </script>
  </body>
</html>
